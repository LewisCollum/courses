<!DOCTYPE html>
<html>
  <head>
    <title>Lab 4: Viewing & Lighting</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >    
    <script type="text/javascript" src="../Common/webgl-utils.js"></script>
    <script type="text/javascript" src="../Common/initShaders.js"></script>
    <script type="text/javascript" src="../Common/MV.js"></script>
    <script type="text/javascript" src="lab4.js"></script>
    <script type="text/javascript" src="object.js"></script>
    <script type="text/javascript" src="Drawer.js"></script>
    <script type="text/javascript" src="radial.js"></script>
    <script type="text/javascript" src="matrix.js"></script>
    <script type="text/javascript" src="vector.js"></script>    
    <script type="text/javascript" src="form.js"></script>
    <script type="text/javascript" src="frameEventDispatcher.js"></script>            
    <link rel="stylesheet" href="style.css">
    
    <script id="vertex-shader" type="x-shader/x-vertex">
      precision mediump float;
      
      struct Color {
          vec3 ambient;
          vec3 diffuse;
          vec3 specular;
      };

      struct Light {
          Color color;
          vec3 position;
      };

      struct DirectionalLight {
          Color color;
          vec4 direction;
      };

      struct Camera {
          mat4 view;
          mat4 viewInverse;          
          mat4 projection;
      };

      Color falloffAtPositionFromLight(vec4 position, Light light) {
          float distance = length(light.position - position.xyz);          
          float falloffScalar = 0.00005 * pow(distance, 2.0);
          
          Color falloffColor;
          falloffColor.ambient = light.color.ambient / falloffScalar;
          falloffColor.diffuse = light.color.diffuse / falloffScalar;
          falloffColor.specular = light.color.specular / falloffScalar;
          return falloffColor;
      }      

      attribute vec4 vertexPosition;
      attribute vec3 vertexNormal;
      uniform mat4 transformation;

      uniform Camera camera;
      uniform Light lights[2];

      varying vec3 fragmentDirectionToLight;
      varying vec3 fragmentDirectionToCamera;
      varying vec3 fragmentNormal;

      varying vec3 targetAmbient, targetDiffuse, targetSpecular;
      
      void main() {
          gl_PointSize = 1.0;
          
          vec4 transformedPosition = camera.view * transformation * vertexPosition;
          gl_Position = camera.projection * transformedPosition;
              
          Color targetFalloff = falloffAtPositionFromLight(transformedPosition, lights[0]);
          targetAmbient = targetFalloff.ambient;
          targetDiffuse = targetFalloff.diffuse;
          targetSpecular = targetFalloff.specular;
          
          fragmentDirectionToLight = normalize(lights[0].position - transformedPosition.xyz);
          fragmentDirectionToCamera = normalize(-transformedPosition.xyz);
          fragmentNormal = normalize((camera.viewInverse * transformation * vec4(vertexNormal, 1.0)).xyz);
      }
    </script>
    
    <script id="fragment-shader" type="x-shader/x-fragment">
      precision mediump float;

      struct Color {
          vec3 ambient;
          vec3 diffuse;
          vec3 specular;
      };

      struct FragmentDirection {
          vec3 toLight;
          vec3 toCamera;
          vec3 normal;
      };

      struct Fragment {
          FragmentDirection direction;
          Color color;
      };
          
      struct Light {
          Color color;
          vec3 position;
      };
      
      uniform Light lights[2];
      float shininess = 4.0;

      varying vec3 fragmentDirectionToLight;
      varying vec3 fragmentDirectionToCamera;
      varying vec3 fragmentNormal;

      varying vec3 targetAmbient, targetDiffuse, targetSpecular;      
      
      void main() {
          FragmentDirection direction;
          direction.toLight = normalize(fragmentDirectionToLight);
          direction.toCamera = normalize(fragmentDirectionToCamera);
          direction.normal = normalize(fragmentNormal);

          Color color;
          color.ambient = lights[0].color.ambient * targetAmbient;
          
          float lambertian = max(dot(direction.toLight, direction.normal), 0.0);
          color.diffuse = lights[0].color.diffuse * targetDiffuse * lambertian;
          
          vec3 reflection = reflect(-direction.toLight, direction.normal);
          float directivity = dot(reflection, direction.toCamera);
          float shine = pow(max(directivity, 0.0), shininess);
          color.specular = lambertian > 0.0 ? lights[0].color.specular * shine : vec3(0.0);

          vec3 clampedPhongSum = clamp(color.diffuse + color.ambient + color.specular, 0.0, 1.0);
          gl_FragColor = vec4(clampedPhongSum, 1.0);
      }
    </script>
  </head>

  <body onload = "init()">
    <div class="container" id="cameraContainer">
      <form id="cameraPanel" class="sidepanel">
        <p>Projection</p>
        <ul id="projectionChoices"></ul>
        <p>Lights</p>
        <ul id="lightChoices"></ul>
        <p>Modifiers</p>
        <ul id="lightModifierChoices"></ul>
      </form>

      <button class="openbtn" id="cameraPanelButton">&#9776;</button>
      <script>
        var choiceCount = 0;
        function generateChoice(label, inputType, subType="") {
            var choice = document.createElement("li");
            choice.setAttribute("id", `li_${label}${subType}`)
            choice.innerHTML = `<input type=${inputType} value='${label}${subType}' name='${inputType}${subType}' id='${label}${subType}'/>
              <label for='${label}${subType}'>${label}</label>`
            choiceCount += 1
            return choice
        }

        function labelsToChoices(labels, inputType, subType="") {
            var choices = []
            labels.forEach((label) => {
                choices.push(generateChoice(label, inputType, subType))
            })
            return choices
        }

        function choicesToElementChildren(choices, element) {
            choices.forEach((choice) => {
                element.appendChild(choice)
            })
        }

        var currentProjection = null
          
        var projectionChoicesContainer = document.getElementById("projectionChoices")
        var projectionLabels = ['Parallel', 'Perspective']
        var projectionChoices = labelsToChoices(projectionLabels, "radio")
        projectionChoices.forEach((choice) => {
            projectionChoicesContainer.appendChild(choice)
        })

        var lightChoicesContainer = document.getElementById("lightChoices")        
        var lightLabels = ['Spot', 'Point']
        var lightChoices = labelsToChoices(lightLabels, "checkbox", "_light")
        lightChoices.forEach((choice) => {
            lightChoicesContainer.appendChild(choice)
        })

        var lightChoicesContainer = document.getElementById("lightModifierChoices")        
        var lightLabels = ['Specular']
        var lightChoices = labelsToChoices(lightLabels, "checkbox", "_lightModifier")
        lightChoices.forEach((choice) => {
            lightChoicesContainer.appendChild(choice)
        })

        var currentProjectionElement = document.getElementById("Parallel")
        currentProjectionElement.checked = true
        currentProjection = currentProjectionElement.value

        var selectionSubject = {
            observers: [],
            addObserver: function(observer) {
                this.observers.push(observer)
            },
            notify: function(selection) {
                this.observers.forEach((observer) => {
                    observer(selection)
                })
            }
        }
        selectionSubject.addObserver(console.log)
        
        var checkedLights = new Set()
        var checkedModifiers = new Set()          
          document.forms.cameraPanel.addEventListener('change', function(event) {
              if(event.target.name === 'radio') {
                  currentProjection = event.target.value
              }
              else if (event.target.name === 'checkbox_light') {
                  let value = event.target.value
                  let light = value.split("_")[0]
                  let type = value.split("_")[1]                  
                  
                  if (checkedLights.has(light)) checkedLights.delete(light)
                  else checkedLights.add(light)
              }
              else if (event.target.name === 'checkbox_lightModifier') {
                  let value = event.target.value
                  let modifier = value.split("_")[0]
                  let type = value.split("_")[1]
                  
                  if (checkedModifiers.has(modifier)) checkedModifiers.delete(modifier)
                  else checkedModifiers.add(modifier)
              }

              selectionSubject.notify({
                  projection: currentProjection,
                  lights: checkedLights,
                  modifiers: checkedModifiers
              })
          });
          
          var panel = document.getElementById("cameraPanel")
          panel.addEventListener('click', (event) => event.stopPropagation())
          
          var cameraPanelButton = document.getElementById("cameraPanelButton")
          cameraPanelButton.addEventListener('click', (event) => {
              event.stopPropagation()
              panel.style.width = "100px"
          })

          document.addEventListener('click', () => panel.style.width = "0")
        </script>
      <canvas id="gl-canvas" height="512" width="512"></canvas>
    </div>
  </body>
</html>
